@model IEnumerable<GardenHub.Models.DailyRecord>

@{
    ViewData["Title"] = "Daily Records Dashboard";
    var days = ViewData["Days"] as int? ?? 30;
}

<div class="records-dashboard-fixed-container">
    <div class="mb-4">
        <h1 class="display-5">
            <i class="bi bi-graph-up"></i> Daily Records Dashboard
        </h1>
        <p class="text-muted">Track environmental changes over time</p>
    </div>

    <!-- Filter Controls -->
    <div class="mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <form asp-action="Dashboard" method="get" class="records-filter-form">
                    <div class="records-filter-group">
                        <label for="gardenId" class="form-label">Filter by Garden</label>
                        <select name="gardenId" id="gardenId" class="form-select" asp-items="ViewBag.GardenId">
                            <option value="">All Gardens</option>
                        </select>
                    </div>
                    <div class="records-filter-group">
                        <label for="days" class="form-label">Time Period</label>
                        <select name="days" id="days" class="form-select">
                            <option value="7" selected="@(days == 7)">Last 7 Days</option>
                            <option value="14" selected="@(days == 14)">Last 14 Days</option>
                            <option value="30" selected="@(days == 30)">Last 30 Days</option>
                            <option value="60" selected="@(days == 60)">Last 60 Days</option>
                            <option value="90" selected="@(days == 90)">Last 90 Days</option>
                        </select>
                    </div>
                    <div class="records-filter-group">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-funnel"></i> Apply Filter
                        </button>
                    </div>
                    <div class="records-filter-group">
                        <a asp-action="Index" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-table"></i> View All Records
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No records found for the selected criteria. 
            <a asp-action="Create" class="alert-link">Create a new record</a>
        </div>
    }
    else
    {
        <!-- Summary Statistics -->
        <div class="records-stats-row mb-4">
            <div class="records-stat-card">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="text-primary mb-2">
                            <i class="bi bi-thermometer-half" style="font-size: 2.5rem;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Avg Inside Temp</h6>
                        <h3 class="mb-0">@Model.Average(r => r.InsideTemperature).ToString("F1")°</h3>
                    </div>
                </div>
            </div>
            <div class="records-stat-card">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="text-info mb-2">
                            <i class="bi bi-droplet-half" style="font-size: 2.5rem;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Avg Inside Humidity</h6>
                        <h3 class="mb-0">@Model.Average(r => r.InsideHumidity).ToString("F1")%</h3>
                    </div>
                </div>
            </div>
            <div class="records-stat-card">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="text-success mb-2">
                            <i class="bi bi-cloud-drizzle" style="font-size: 2.5rem;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Avg Inside VPD</h6>
                        <h3 class="mb-0">@Model.Average(r => r.InsideVPD).ToString("F2") kPa</h3>
                    </div>
                </div>
            </div>
            <div class="records-stat-card">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="text-warning mb-2">
                            <i class="bi bi-calendar3" style="font-size: 2.5rem;"></i>
                        </div>
                        <h6 class="text-muted mb-2">Total Records</h6>
                        <h3 class="mb-0">@Model.Count()</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Temperature Chart -->
        <div class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-thermometer-half text-danger"></i> Temperature Trends</h5>
                </div>
                <div class="card-body">
                    <div class="records-chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Humidity Chart -->
        <div class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-droplet text-primary"></i> Humidity Trends</h5>
                </div>
                <div class="card-body">
                    <div class="records-chart-container">
                        <canvas id="humidityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- VPD Chart -->
        <div class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-cloud-drizzle text-success"></i> VPD (Vapor Pressure Deficit) Trends</h5>
                </div>
                <div class="card-body">
                    <div class="records-chart-container">
                        <canvas id="vpdChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Records Table -->
        <div class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Recent Records</h5>
                </div>
                <div class="card-body">
                    <div class="records-table-wrapper">
                        <table class="table table-hover records-table" id="recordsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Garden</th>
                                    <th>Inside Temp</th>
                                    <th>Outside Temp</th>
                                    <th>Inside Humidity</th>
                                    <th>Outside Humidity</th>
                                    <th>Inside VPD</th>
                                    <th>Outside VPD</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.CreatedDate.ToLocalTime().ToString("MMM dd, yyyy")</td>
                                        <td>@item.Garden?.GardenDescription</td>
                                        <td>@item.InsideTemperature.ToString("F1")°</td>
                                        <td>@item.OutsideTemperature.ToString("F1")°</td>
                                        <td>@item.InsideHumidity.ToString("F1")%</td>
                                        <td>@item.OutsideHumidity.ToString("F1")%</td>
                                        <td>@item.InsideVPD.ToString("F2")</td>
                                        <td>@item.OutsideVPD.ToString("F2")</td>
                                        <td>
                                            <a asp-action="Details" asp-route-id="@item.RecordId" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a asp-action="Edit" asp-route-id="@item.RecordId" class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Prepare data from model
        const records = @Html.Raw(Json.Serialize(Model.Select(r => new {
            date = r.CreatedDate.ToString("yyyy-MM-dd"),
            insideTemp = r.InsideTemperature,
            outsideTemp = r.OutsideTemperature,
            insideHumidity = r.InsideHumidity,
            outsideHumidity = r.OutsideHumidity,
            insideVPD = r.InsideVPD,
            outsideVPD = r.OutsideVPD
        })));

        const labels = records.map(r => r.date);

        // Chart configuration
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 14
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            }
        };

        // Temperature Chart
        new Chart(document.getElementById('temperatureChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Inside Temperature (°)',
                        data: records.map(r => r.insideTemp),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Outside Temperature (°)',
                        data: records.map(r => r.outsideTemp),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    title: {
                        display: false
                    }
                }
            }
        });

        // Humidity Chart
        new Chart(document.getElementById('humidityChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Inside Humidity (%)',
                        data: records.map(r => r.insideHumidity),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Outside Humidity (%)',
                        data: records.map(r => r.outsideHumidity),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: chartOptions
        });

        // VPD Chart
        new Chart(document.getElementById('vpdChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Inside VPD (kPa)',
                        data: records.map(r => r.insideVPD),
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Outside VPD (kPa)',
                        data: records.map(r => r.outsideVPD),
                        borderColor: 'rgb(201, 203, 207)',
                        backgroundColor: 'rgba(201, 203, 207, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: chartOptions
        });

        // Initialize DataTable for the records table
        $(document).ready(function() {
            $('#recordsTable').DataTable({
                order: [[0, 'desc']],
                pageLength: 10,
                responsive: false,
                scrollX: false,
                autoWidth: false
            });
        });
    </script>
}